app-id: org.segmecam.SegmeCam
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
command: segmecam_gui

finish-args:
  # X11 access for GUI
  - --socket=x11
  - --share=ipc
  
  # GPU access for OpenGL and CUDA
  - --device=dri
  - --socket=pulseaudio
  
  # Camera access
  - --device=all
  
  # File system access for custom backgrounds
  - --filesystem=xdg-pictures:ro
  - --filesystem=home:ro
  
  # Network for downloading models (if needed)
  - --share=network

modules:
  - name: bazel
    buildsystem: simple
    build-commands:
      - install -Dm755 bazel /app/bin/bazel
    sources:
      - type: file
        url: https://github.com/bazelbuild/bazelisk/releases/download/v1.19.0/bazelisk-linux-amd64
        dest-filename: bazel
        sha256: d28b588ac0916abd6bf02defb5433f6eddf7cba35ffa808eabb65a44aab226f7

  - name: mediapipe
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DMEDIAPIPE_DISABLE_GPU=OFF
    sources:
      - type: archive
        url: https://github.com/google-ai-edge/mediapipe/archive/v0.10.8.tar.gz
        sha256: c4554f9f41192202263c19cc0f6e330b42f003bbfc5ce16ba727ab4c71ad6e5d

  - name: opencv
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_TESTS=OFF
      - -DBUILD_EXAMPLES=OFF
      - -DBUILD_DOCS=OFF
      - -DBUILD_PERF_TESTS=OFF
      - -DWITH_FFMPEG=ON
    sources:
      - type: archive
        url: https://github.com/opencv/opencv/archive/4.8.0.tar.gz
        sha256: cbf47ecc336d2bff36b0dcd7d6c179a9bb59e805136af6b9670ca944aef889bd

  - name: segmecam
    buildsystem: simple
    build-commands:
      # Skip MediaPipe download since it's already built as a module
      - export MEDIAPIPE_BUILT=1
      
      # Build SegmeCam
      - bazel build //...
      
      # Install binaries
      - install -Dm755 bazel-bin/segmecam_gui /app/bin/segmecam_gui
      - install -Dm755 bazel-bin/segmecam /app/bin/segmecam
      
      # Install assets
      - mkdir -p /app/share/segmecam
      - cp -r models/ /app/share/segmecam/
      - cp -r assets/ /app/share/segmecam/
      
      # Install desktop file and appdata
      - install -Dm644 org.segmecam.SegmeCam.desktop /app/share/applications/org.segmecam.SegmeCam.desktop
      - install -Dm644 org.segmecam.SegmeCam.appdata.xml /app/share/metainfo/org.segmecam.SegmeCam.appdata.xml
      - install -Dm644 assets/SegmeCam.png /app/share/icons/hicolor/256x256/apps/org.segmecam.SegmeCam.png
      
    sources:
      - type: git
        url: https://github.com/Padletut/segmecam.git
        branch: main